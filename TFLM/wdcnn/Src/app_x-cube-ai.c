
/**
  ******************************************************************************
  * @file    app_x-cube-ai.c
  * @author  X-CUBE-AI C code generator
  * @brief   AI program body
  ******************************************************************************
  * @attention
  *
  * Copyright (c) 2023 STMicroelectronics.
  * All rights reserved.
  *
  * This software is licensed under terms that can be found in the LICENSE file
  * in the root directory of this software component.
  * If no LICENSE file comes with this software, it is provided AS-IS.
  *
  ******************************************************************************
  */

 /*
  * Description
  *   v1.0 - Basic template to show how to use the TensorFlow lite micro API
  *
  */

#ifdef __cplusplus
 extern "C" {
#endif

/* Includes ------------------------------------------------------------------*/

/* System headers */
#include <stdint.h>
#include <stdlib.h>
#include <stdio.h>
#include <inttypes.h>
#include <string.h>

#include "app_x-cube-ai.h"
#include "main.h"

/* USER CODE BEGIN includes */
#include "gpio.h"
#include "usart.h"
#include "stdio.h"
/* USER CODE END includes */

#include <tflm_c.h>
/* Global handle - used to reference the instantiated model */
static uint32_t model_hdl = 0;

/* tflm_io_write() is the final callback implementation to implement the DebugLog() function
 * requested by the tflite::MicroErrorReporter object
 */
int tflm_io_write(const void *buff, uint16_t count)
{

    /*
     * add here where to send the log messages
     * for example
     *   HAL_StatusTypeDef status;
     *   status = HAL_UART_Transmit(&UartHandle, (uint8_t *)buff, count,
     *       HAL_MAX_DELAY);
     *
     * return (status == HAL_OK ? count : 0);
     */
     return((int)count);
}

static int ai_boostrap(const uint8_t *model, uint8_t *arena_addr,
    size_t arena_sz)
{
  TfLiteStatus res;
  int32_t size_io;

  /* USER CODE BEGIN 1 */
  printf("\r\nInstancing the network (TFLM)..\r\n");
  /* USER CODE END 1 */

  res = tflm_c_create(model, (uint8_t*)arena_addr, arena_sz, &model_hdl);

  if (res != kTfLiteOk) {
    return -1;
  }

  /* USER CODE BEGIN 2 */

  /* Report the main model info */

  printf(" Operator size      : %d\r\n", (int)tflm_c_operators_size(model_hdl));
  printf(" Tensor size        : %d\r\n", (int)tflm_c_tensors_size(model_hdl));

  /* Report the size of arena buffer which is really used during the set-up and run phases
   * - based on a debug service (see C++ interpreter i/f in tflm_c.cc file)
   * - after this step, no additional memory should be allocated from the arena buffer or
   *   through another system heap allocator.
   * Note: This info is useful to refine/adjust the requested size of the arena buffer.
   */
  printf(" Allocated size     : %d / %d\r\n", (int)tflm_c_arena_used_bytes(model_hdl),
      (int)arena_sz);

  /* Report the description of the IO tensors */

  size_io = tflm_c_inputs_size(model_hdl);
  printf(" Inputs size        : %d\r\n", (int)size_io);

  for (int i=0; i<size_io; i++) {
    struct tflm_c_tensor_info t_info;
    tflm_c_input(model_hdl, i, &t_info);
    printf("  %d: %s (%d bytes) (%d, %d, %d)", i, tflm_c_TfLiteTypeGetName(t_info.type),
        (int)t_info.bytes, (int)t_info.height, (int)t_info.width, (int)t_info.channels);
    if (t_info.scale)
      printf(" scale=%f, zp=%d\r\n", (float)t_info.scale, (int)t_info.zero_point);
    else
      printf("\r\n");
  }

  size_io = tflm_c_outputs_size(model_hdl);
  printf(" Outputs size       : %d\r\n", (int)size_io);

  for (int i=0; i<size_io; i++) {
    struct tflm_c_tensor_info t_info;
    tflm_c_output(model_hdl, i, &t_info);
    printf("  %d: %s (%d bytes) (%d, %d, %d)", i, tflm_c_TfLiteTypeGetName(t_info.type),
        (int)t_info.bytes, (int)t_info.height, (int)t_info.width, (int)t_info.channels);
    if (t_info.scale)
      printf(" scale=%f, zp=%d\r\n", (float)t_info.scale, (int)t_info.zero_point);
    else
      printf("\r\n");
  }

  if ((tflm_c_inputs_size(model_hdl) != 1) || (tflm_c_inputs_size(model_hdl) != 1)) {
    printf("WARNING - embedded TFL model is not compitable with the default template..\r\n");
  }

  /* USER CODE END 2 */

  return 0;
}

/* USER CODE BEGIN 3 */
int acquire_and_process_data(void* data)
{
	printf("Fill the inputs..\r\n");
	return 0;
}

int post_process(void * data)
{
	printf("Process the outputs..\r\n");
	return 0;
}
/* USER CODE END 3 */

/* USER CODE BEGIN 4 */

/*
 * The following code is based on the generated/specific
 * network_tflite_data.h/.c files. These files embed a full
 * image of the TFLite file as a C-array
 * (g_tflm_network_model_data[]).
 *
 * Note: Thanks to X-CUBE-AI, a pre-calculated ARENA size is
 *       also provided (TFLM_NETWORK_TENSOR_AREA_SIZE).
 *       With the default TFLight micro environment, no
 *       service is available to report it. Recommended approach
 *       is to provide an initial size (roughly estimated by the user)
 *       and to adjust it during the integration phase. Real value
 *       can be only known after the call of the
 *       interpreter::AllocateTensors() function at runtime.
 */

#include "network_tflite_data.h"

#define BIN_ADDRESS &g_tflm_network_model_data[0]
#define ARENA_SIZE  TFLM_NETWORK_TENSOR_AREA_SIZE

/* Allocate the arena buffer to install the model
 *  - Size should be aligned on 16-bytes.
 *   Note: This is not really strict, but avoid to have a
 *         specific warning/debug message during the
 *         set-up phase. At the end, memory will be aligned by
 *          the TFLight micro runtime it-self.
 */

#define _CONCAT_ARG(a, b)     a ## b
#define _CONCAT(a, b)         _CONCAT_ARG(a, b)

#if defined(_MSC_VER)
  #define MEM_ALIGNED(x)
#elif defined(__ICCARM__) || defined (__IAR_SYSTEMS_ICC__)
  #define MEM_ALIGNED(x)         _CONCAT(MEM_ALIGNED_,x)
  #define MEM_ALIGNED_16         _Pragma("data_alignment = 16")
#elif defined(__CC_ARM)
  #define MEM_ALIGNED(x)         __attribute__((aligned (x)))
#elif defined(__GNUC__)
  #define MEM_ALIGNED(x)         __attribute__((aligned(x)))
#else
  #define MEM_ALIGNED(x)
#endif

MEM_ALIGNED(16)
static uint8_t tensor_arena[TFLM_NETWORK_TENSOR_AREA_SIZE];

MEM_ALIGNED(16)
static float tensor_input[1024] = {
  0.8312889, 0.59552985, 0.7055061, -0.74051154, 0.8136159, 0.5630838, -0.5576377, -0.93141377, -0.4973467, -0.9009402, 0.65077204, -0.1849877, -0.39615694, -0.6945684, -0.68337464, 0.79250044, -0.7723535, 0.4275423, -0.9122649, -0.29792643, 0.9579396, 0.7948459, -1.1055012, -1.1248194, 0.77582836, 0.353905, -0.93072957, 0.22030027, 0.8601178, 0.37077266, -0.68743265, 0.12829436, 0.75611013, 0.8475423, -0.7390106, -0.06658897, -0.78172034, 0.835354, 0.83479786, -0.6906372, 0.798759, -0.71842045, 0.7881086, -0.827242, 0.8714192, 0.8913144, 0.69999796, -0.5985335, -0.80444014, 0.9038846, 0.7132256, -0.9705723, -0.76820225, 0.74630207, -0.112322964, 0.19382386, -0.9197316, 0.82598644, -0.7552724, 0.7150806, -0.24716073, 0.5189989, -0.141302, -0.8655368, -0.76017433, -0.7765001, -0.7896643, -0.49531707, -0.69428307, -0.14739303, 0.9158377, 0.8423463, 0.5475082, -0.88309956, -1.0695139, 0.7596056, -0.8493529, -0.787509, 0.58455247, 0.9332767, -0.5913164, -1.5730015, -1.2260628, -0.9291537, -0.8925111, 0.14142801, 0.37944528, 1.3415612, -0.9125697, -1.3290175, 0.6438903, -0.31392533, 1.4314182, 1.1776438, -0.3782967, -0.08006098, 1.2708195, 0.13083473, -0.4870104, -0.8998249, 1.1007338, -0.19070882, 0.39633703, 0.5814578, -0.7002082, -1.3328454, 0.22427884, 0.43741125, -1.1111587, -0.6352284, -0.36374038, 0.056347564, -0.4241252, -0.09567714, -0.58380514, 0.76011926, 1.1255274, 0.63816494, 0.59278184, -0.66061074, -0.4255208, 0.8070695, 0.13063368, -0.9510597, 0.4698173, 0.502908, 0.16264835, 0.583696, 0.4105562, 0.6184035, -0.2740192, 0.78476673, 0.7715003, -0.44206667, -0.2869854, -0.7666275, 0.89631784, 0.07230147, 0.50770783, 0.94094825, 0.14105679, -0.9268302, 0.45762175, -0.46196482, -0.9118717, 0.22970532, 0.8200855, 0.8253729, 0.7335447, 0.74539524, 0.7266634, -0.3881549, 0.49891484, 0.7575435, -0.7931385, 0.6640747, -0.92113453, 0.8125029, 0.6550075, 0.15728436, 0.87843895, -0.7303704, -0.80847716, 0.7987199, 0.872218, 0.59196323, -0.7531059, -0.6697498, 0.4457787, 0.8414168, -0.74446434, -0.32300738, 0.16852415, -0.84320647, -0.8391992, -0.13556392, -0.5586516, 0.7300327, 0.70676035, 0.965719, 0.6495154, 0.7669542, 0.7263299, -0.5694713, -0.09579336, 0.7380723, 0.81108755, 0.87207556, 0.8462851, 0.27891374, 0.81412816, -0.40601337, 0.47804368, 0.34138042, -0.946523, -0.7180443, -0.69332063, -1.2809641, 0.6868333, 0.6877788, 0.1080816, -1.162012, 0.3099629, 1.1460019, -1.6762081, -1.1160215, 2.3358748, -0.19766916, -3.0589082, 0.5420557, -0.22078367, 0.47534811, 0.12879607, 0.9476673, -0.09694997, -1.5995655, 0.45468473, 1.1378058, -1.1144924, -0.289394, 1.118833, 0.6232178, -1.8317621, 1.0568907, 0.053176064, -1.5091397, -1.5885227, 1.3273221, 1.0809091, -1.229923, -0.9679382, -0.33906314, 0.77561045, -1.1624413, 0.8641493, -0.6906163, 0.076840766, -0.10632534, -0.28326783, 0.2931268, 0.7867949, -1.0016829, -0.7449071, -0.34196135, -0.818846, 0.57480043, 0.8779371, -0.25276628, -0.22651955, 0.9669141, -0.56728774, -0.36493233, 0.61758286, -0.39438954, -0.4205217, -1.1001668, -0.7666026, 0.31425428, -0.3255856, -1.2215754, 0.9295472, 0.8983056, 0.31308407, 0.51308227, 1.0414602, -0.22079465, -0.570802, -0.8678586, 0.9904992, -0.1903739, -0.5260135, 0.18652615, 0.17648345, 0.78964686, -0.9088616, -0.76025254, -0.359344, -0.83198893, -0.14256673, 0.63657725, 0.35719058, 0.62731606, 0.79241216, -0.8095426, -0.48380563, 0.54155034, -0.24698716, 0.93060774, -0.9210488, 0.024865787, 0.9370071, -0.92507684, -1.2380441, 0.6926101, 0.9423799, 0.763715, 0.7270127, 1.167535, 0.9828208, -1.0327604, 0.06944552, 1.2241352, 0.46343237, 1.4090028, 2.118662, -0.30371237, -5.599737, -0.75315845, 4.040946, -2.3643298, -1.9348264, 0.54363066, 8.250249, -4.4595237, -5.9106436, 2.2654927, 4.745388, 0.44587865, 1.6703482, -0.81710565, -0.013793547, 5.2362223, 1.8978759, -1.1141875, -2.2482145, 7.1271954, 0.020196997, -9.817006, -1.206382, 4.129817, -2.2684991, -5.0150228, -1.3859577, 1.3914459, -1.1235454, -0.18622757, -0.917171, -0.8291222, 3.8358567, 4.142771, -1.7317675, -1.0200902, 4.987344, 0.5647032, -3.2861044, -2.0881965, 3.5204368, -0.23325476, -2.6744344, -0.29475203, -0.36949044, 0.46181288, 0.3085502, -1.7189128, 0.20456342, -0.41737118, 2.0882087, -0.299612, -1.9088508, 0.60319394, 2.7858546, -0.8380804, -1.5304105, 1.2245492, 0.9749501, 1.0276672, -1.0897515, 0.07452823, 0.8809644, 0.68713355, -0.92015314, -0.8507068, -1.0341815, 0.61994094, -0.6226531, 0.47407895, -1.1006066, 0.15284492, -1.0269417, 1.0640714, -0.69967544, 0.24875388, 0.815905, 0.5027748, 0.97512865, -0.073374815, 0.7698618, 0.8368434, -0.112073325, -0.61749196, -1.0596981, -1.5516531, -1.0814272, -0.5523388, 0.49153793, 0.46499947, -1.4735254, -1.0646286, -0.6048333, -0.6958549, -0.34676343, -0.39445117, 0.34490407, 2.018721, 1.5085565, 0.21022677, -0.9984923, 1.7945306, 1.3501699, -1.1261053, 0.17099202, -1.1217792, -0.82874686, -1.2795119, -1.9209688, -0.8919116, -0.743467, 0.5476118, 0.33903474, -0.65187675, 0.5263264, 1.0863521, 1.1014434, -0.51408416, 0.41802397, 1.3773195, 1.213653, -0.66704977, -1.0230701, 0.014923114, -0.3683298, -0.5886147, -1.9362758, -0.6084964, 0.341223, 0.026893789, 0.575956, -0.7416618, -0.632717, -0.6858337, -0.017622858, 0.99526006, -0.74049133, 1.0057149, 0.9346816, 0.52570474, -0.8427558, 0.9409988, 0.8043348, -1.0675759, 0.80029064, -0.044193894, -0.14144626, -0.33268082, 0.34216055, -0.74763864, -0.057683848, 0.50925845, 0.69631016, 0.2124505, 0.8970257, -0.26639482, 0.6552538, 0.91726935, 0.85654134, 0.045150194, 0.3761779, -0.6337845, -0.5965438, 0.67493737, 0.7666471, -0.4570467, 1.1775148, 0.099603616, 0.44835135, 0.63586634, -0.12531337, -0.843535, 0.027354322, 0.7014246, 0.47069833, -0.26187032, -1.3080153, -1.1920354, 0.5020954, -0.6517771, -0.70840156, -0.80606383, 0.9864819, 0.23568551, -0.682104, 1.019633, -0.16509984, 0.9305215, 0.7858843, 0.5459119, 0.0059593925, -0.13590002, -0.00115304, 0.73457545, -0.15245211, 0.51839703, -0.94828415, 0.672091, -0.74708825, 0.17559063, -0.89765465, -1.0357966, 0.65283835, 0.8675601, -0.10760989, 0.8149757, 0.32421565, 0.035801888, 0.82549816, -0.47348076, -0.8490078, 0.63423574, -0.6761805, 0.7745533, 0.66085076, 1.0331688, 0.9946128, -1.0022902, -0.8449432, -0.4083461, -0.48750633, -0.90658253, -0.5515528, -0.77460295, -1.1901994, -0.96516687, -0.6252817, 0.2606199, 0.005807052, 0.5643552, 0.8070315, 0.22600473, 0.6294447, 1.0651047, 0.820434, 0.8949059, 0.10027556, 0.83679247, -0.8103628, 1.3020655, 1.1888163, -0.8435268, 0.90016615, 1.087022, -0.7414507, -0.995296, 0.43997362, -0.78650784, -0.94636464, -1.2996844, -1.3124763, 0.7671864, -0.11754668, -0.9443381, -0.54453844, 0.7486712, -0.415684, 0.9625405, 0.028426642, -0.37164408, -0.23141176, 0.54011685, -0.63854057, 0.7823544, -0.5645639, 1.0692983, 0.8654232, -0.91542846, 0.74634135, 0.7914287, -0.83279717, 0.5427664, -0.6640722, 0.71383464, -0.5672697, -0.3875329, 0.08615026, -0.93814814, 0.3439374, -0.45616168, -0.845194, -0.4167151, -0.33589232, -0.55689263, -0.7221494, 0.6988434, 0.48785222, 0.49847716, 0.38803145, -0.6321452, -0.9706493, 0.6839735, 0.6742731, -0.8393771, 0.72657037, -0.9314037, 0.73767614, -0.827271, -0.16346785, -0.7907728, 0.5775997, 0.74765706, -0.60509026, -0.6163088, -0.5165942, 1.0277836, 0.83102787, -0.4463978, 0.77616554, -0.81176645, 0.46925128, -0.03175792, -1.0926532, -0.9149919, 0.23651055, -0.79731935, 0.7590932, 0.67658687, -0.8479251, -0.13018805, -0.39176017, 0.8239751, -0.713537, -0.7572269, -0.7204332, 0.9676918, -0.70268184, 0.8710821, -0.7449461, -0.78336793, -0.9607135, -0.4929073, 1.0362179, 0.18685997, 0.4293661, -0.24914357, 0.9547932, 3.3291872, -0.6050633, -3.4242995, 1.9082855, 1.5361078, -1.8734655, -1.6212467, 0.95972276, 0.8529788, 0.5604692, 1.0676857, -0.16774583, 0.34531116, 1.8661599, -0.09650593, -2.9489825, 0.5168733, 2.6754394, -1.8580333, -2.7824402, -0.15077725, 0.170743, 0.1855996, -1.877316, -1.1707909, -1.1665567, -0.9915494, 0.84053814, 0.5646021, 1.2093586, 0.32660058, 0.7877453, 0.49955314, -0.96933895, 1.2295992, 0.95569324, -1.4772133, -0.86794037, 1.9295381, 1.0360214, -1.4987895, -1.0381032, -0.4571841, -1.2374756, -1.9318533, 0.47825736, -0.6324595, -0.6537965, 0.53348666, 0.48398635, 0.7010735, 0.9607383, 0.81317663, -0.19323485, -0.09732048, -0.7357057, 0.29800987, 0.5102723, 0.36074382, 0.23830493, -0.76599455, 0.3096741, 0.054732777, -0.36644748, -0.15577231, -1.1050063, 0.8641678, 0.91016966, 0.12370466, -0.7612375, -0.20934123, 0.8272598, -0.67460746, -0.9626182, -0.58340716, 0.3531499, 0.9233149, 0.92777807, -0.63538784, 0.9019032, -0.5158558, -1.035484, 0.45177424, -0.7460347, -0.9498256, 0.1413472, -0.8458847, 0.8977532, 0.48104402, -0.78876644, -0.8989603, 0.9270254, -0.42228505, 0.7700497, -0.846049, -0.6013262, 0.9852113, -0.7981874, 0.7837118, 0.13292983, 0.42606285, -0.4197218, 0.34737146, -0.82365227, 0.9577931, -0.7938805, -0.3642948, 0.36288187, -0.37286574, 0.5802696, 1.0176947, -1.7043906, -4.5704885, 0.68419784, 0.6844318, 0.26676333, 0.43031523, -0.0075716507, 1.20745, -1.3070667, 0.42058393, 0.98292845, 0.5670181, -0.23371454, 2.5939088, 2.326995, -2.6730163, 0.34353432, 0.16049106, -0.9610475, -2.736878, -0.2025918, -0.3587612, -2.807893, -0.9036536, -0.10837834, -1.6451135, -2.1802042, 1.5782281, 0.9328316, -1.8857621, -1.1525545, 1.8336662, 0.93226105, 0.53168964, -0.14759628, 1.4600687, -0.52828324, 0.20409498, 0.7361466, 1.0621575, -1.0455984, 0.35164064, 0.4316461, -0.79423845, -1.0402347, -0.67632437, -0.75348854, -0.84949005, 0.60121596, 0.36081508, -0.6348762, 0.7417121, -0.49950394, 1.0987875, -0.67367715, 0.080223836, -0.90963006, 1.3163744, -0.34286848, -1.287838, 0.3507558, 1.2055268, -0.8120179, -1.0984755, -0.073105454, 1.0628347, -0.96726453, 0.1881992, 0.81322986, -0.16061753, 0.17356986, -0.52143407, 0.950734, -0.5077755, -0.3036154, 0.64912707, 1.1223942, 0.83094877, 0.5931214, -0.7555643, 0.8400584, -0.94349235, 0.38060853, -0.2853519, -1.2063193, -1.0142132, -0.058012802, 0.19125254, -1.2552252, -0.88685256, -0.49565163, 0.54622954, -1.2714095, 0.21149534, 0.057641238, 0.69685143, -1.1426334, 1.0550343, 0.9683855, 0.47191015, 0.57494694, 1.0487199, -0.46798506, -1.1542369, -0.757606, 0.9535678, -0.7262839, -0.6456494, -0.31151482, 0.5290183, -0.6691198, 0.8847272, -0.84542584, 0.052197535, -0.16634178, -0.011386165, 0.45745096, -1.0743638, 1.0663651, 0.5470159, 1.5220785, 0.28727332, 0.022908522, 1.8027468, -0.15360579, -0.27405503, -1.5430303, -0.15974918, -0.40430206, -2.273482, 0.22446638, 0.90668756, -0.8681899, 0.48089236, 0.82238823, -1.4244691, 0.09439239, 1.4066259, 0.4928681, -1.157108, 1.1402949, 0.2604537, -0.74498075, -0.26521876, 0.92013294, 0.3517515, 0.66193855, 0.59029794, 0.8028196, 0.6241591, -0.025894035, -1.0268227, 0.70200825, -0.86644214, 0.548635, 0.69443005, -0.72205925, -0.55451053, 0.5912404, -0.8610341, -0.6162029, 0.20582414, 0.9601668, 0.84043944, -0.34865063, 0.66403615, -0.5921284, 1.0028086, -0.75019306, -0.27859154, 0.73406196, 0.4949424, -0.28608376, 0.6422284, -0.66725516, -0.63322675, -0.9655927, -0.88407075, -0.6287741, 0.81223124, -1.0279267, -0.26111713, -0.7446892, 0.42407945, -0.86309224, 0.86359745, -0.027301887, -0.69363856, -0.8801387, -0.88397753, 0.85849017, 0.4439469, 0.23967421, 1.014212, 0.7086588, -0.42125762, 0.82655233, -0.43907914, 0.5951559, -0.9776668, -0.117474705, 0.7111488, -0.78607386, 0.7641664, -0.6907399, -0.14854264, -0.9504058, -0.12624009, -0.63163275, 0.4292586, -0.71804297, 0.97827566, -0.7928179, 0.6334644, -1.0193106, -0.7975989, -0.46957517, -0.7301523, 0.8575697, 0.975385, 0.60476696, 0.2988908, -0.92722106, 0.45345166, -1.0457474, -0.50196373, -0.66341627, -0.83040565, -0.8789864, -0.56853384, 0.8980684, -1.1941773, -0.9109104, -0.523166, 0.055104394, -0.91167194, -0.6539259, -0.069283605, -0.7752756, 0.63586956, -0.97443175, -0.86477834, -0.840687, 0.31994313, -0.7034435, 0.8092246, 0.40631217, 0.5647098, 0.51528865, -0.49932837, 0.85040295, -0.4860985, -0.6761562, -0.611329, 0.6275084, -0.13005789, 0.7698745, -0.42973107, 0.08335461, 0.840222, -0.62267697, -0.87041837, 0.48575604, 0.495822, 0.7473866, -1.0965219, 0.67017716, -0.8032256, -0.78999466, 0.6687443,   
};

MEM_ALIGNED(16)
static float tensor_output[10];
/* USER CODE END 4 */

/* Entry points --------------------------------------------------------------*/

void MX_X_CUBE_AI_Init(void)
{
    /* USER CODE BEGIN 5 */
  int res;

  //printf("\r\nTEMPLATE - initialization\r\n");

  res = ai_boostrap(BIN_ADDRESS, tensor_arena, ARENA_SIZE);
  if (res) {
    printf("E: unable to instantiate the embedded image of the TFLite model/file..\n\r");
    return;
  }
    /* USER CODE END 5 */
}

void MX_X_CUBE_AI_Process(void)
{
    /* USER CODE BEGIN 6 */
      volatile int res;

  float *in_data = NULL;
  float *out_data = NULL;
  int32_t flag;


  //printf("TEMPLATE TFLM - run - main loop\r\n");

  if (model_hdl) {

    /* 1 - Retrieve the addresses of the IO buffers (index=0) */
    struct tflm_c_tensor_info info;

    tflm_c_input(model_hdl, 0, &info);
    in_data = (float *)info.data;
    for (int i = 0; i < 1024; i++)
    {
      in_data[i] = tensor_input[i];
    }
    tflm_c_output(model_hdl, 0, &info);
    out_data = (float *)info.data;

    printf("start\r\n");
    for (int i = 0; i < 100; i++)
    {
      flag = tflm_c_invoke(model_hdl);
    }
    printf("end\r\n");

    if (flag != kTfLiteOk) {
      res = -1;
    }
    else{
      res = 0;
    }    

    for (int i = 0; i < 10; i++)
    {
      tensor_output[i] = out_data[i];
    }


  //   /* 2 - main loop */
  //   do {
  //     /* 1 - acquire and pre-process input data */
  //     res = acquire_and_process_data(in_data);
  //     /* 2 - process the data - call inference engine */
  //     if (res == 0) {
  //       if (tflm_c_invoke(model_hdl) != kTfLiteOk) {
  //         res = -1;
  //       }
  //     }
  //     /* 3- post-process the predictions */
  //     if (res == 0)
  //       res = post_process(out_data);
  //   } while (res==0);
  }

  if (res) {
    printf("E: unable to use the TFLite model..\n\r");
  }
    /* USER CODE END 6 */
}
#ifdef __cplusplus
}
#endif
